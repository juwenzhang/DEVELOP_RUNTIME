# async_hooks

> å¼‚æ­¥é’©å­ ğŸª

:::tip

å®˜æ–¹å¯¹åº”ç½‘é¡µï¼šhttps://nodejs.org/docs/latest/api/async_hooks.html

> Asynchronous context tracking å¼‚æ­¥ä¸Šä¸‹æ–‡è¿½è¸ª

:::

:::warning

å®˜ç½‘æè¿°ï¼š

æˆ‘ä»¬æå…¶ä¸å»ºè®®ä½¿ç”¨ `async_hooks` APIï¼Œå› ä¸ºå…¶ä»–çš„ API å¯ä»¥ç»å¤§ç¨‹åº¦ä¸Šè¦†ç›–å…¶ä½¿ç”¨åœºæ™¯

    * `AsyncLocalStorage` è·Ÿè¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡

    * `process.getActiveResourcesInfo` è·Ÿè¸ªæ¿€æ´»çš„èµ„æº

:::

## æ¦‚å¿µ

:::info

* å¼‚æ­¥èµ„æºè¡¨ç¤ºä¸€ä¸ªå¸¦æœ‰ç›¸å…³å›è°ƒçš„å¯¹è±¡ã€‚

    * è¿™ä¸ªå›è°ƒå¯èƒ½è¢«è°ƒç”¨å¤šæ¬¡ï¼ˆ`multi-times`ï¼‰ï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ï¼š`net.createServer()` ä¸­çš„ `connection` äº‹ä»¶

    * ä¹Ÿå¯èƒ½åªæ˜¯è°ƒç”¨ä¸€æ¬¡(`single-time`)ï¼Œæ¯”å¦‚`fs.open()` é‡Œçš„æƒ…å†µã€‚
    
    * èµ„ä¹Ÿå¯èƒ½åœ¨å›è°ƒè¢«è°ƒç”¨å‰å°±è¢«å…³é—­

* ä½†æ˜¯ `AsyncHooks` æ˜¯ä¸ä¼šå¯¹å…¶è¿›è¡Œä¸€ä¸ªä¸¥æ ¼åŒºåˆ†ï¼Œç»Ÿä¸€ç§°ä¸º `èµ„æº`

> å¦‚æœä½¿ç”¨äº†çº¿ç¨‹ `worker` ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ `async_hooks` çš„æ¥å£ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šä½¿ç”¨ä¸€ç»„æ–°çš„å¼‚æ­¥ `ID`

```javascript
const async_hooks = require('node:async_hooks');

// Return the ID of the current execution context.
const eid = async_hooks.executionAsyncId();

// Return the ID of the handle responsible for triggering the callback of the
// current execution scope to call.
const tid = async_hooks.triggerAsyncId();

// Create a new AsyncHook instance. All of these callbacks are optional.
const asyncHook =
    async_hooks.createHook({ init, before, after, destroy, promiseResolve });

// Allow callbacks of this AsyncHook instance to call. This is not an implicit
// action after running the constructor, and must be explicitly run to begin
// executing callbacks.
asyncHook.enable();

// Disable listening for new asynchronous events.
asyncHook.disable();

//
// The following are the callbacks that can be passed to createHook().
//

// init() is called during object construction. The resource may not have
// completed construction when this callback runs. Therefore, all fields of the
// resource referenced by "asyncId" may not have been populated.
function init(asyncId, type, triggerAsyncId, resource) { }

// before() is called just before the resource's callback is called. It can be
// called 0-N times for handles (such as TCPWrap), and will be called exactly 1
// time for requests (such as FSReqCallback).
function before(asyncId) { }

// after() is called just after the resource's callback has finished.
function after(asyncId) { }

// destroy() is called when the resource is destroyed.
function destroy(asyncId) { }

// promiseResolve() is called only for promise resources, when the
// resolve() function passed to the Promise constructor is invoked
// (either directly or through other means of resolving a promise).
function promiseResolve(asyncId) { }
```

:::

## `async_hooks.createHook(callbacks)`

* callbacks å®ç°çš„æ˜¯å®šä¹‰ä¸€ä¸ªå¯¹è±¡çš„æ•°æ®ç±»å‹å§ï¼Œä»¥åŠåœ¨å†…éƒ¨ä¼šå®ç°æ³¨å†Œä¸€äº›å›è°ƒäº‹ä»¶å§ï¼Œè¿”å›çš„æ˜¯ async_hooks çš„å®ä¾‹

    * init() `function` åˆå§‹åŒ–æ—¶æ‰§è¡Œå›è°ƒ

    * before() `function` æ‰§è¡Œå‰çš„å›è°ƒ

    * after()  `function` å›è°ƒåçš„æ‰§è¡Œå›è°ƒ

    * destory() `function` é”€æ¯æ—¶çš„æ‰§è¡Œå›è°ƒ

    * promiseResolve()

* è¿™äº›æ³¨å†Œçš„å‡½æ•°ä¼šè¢«è°ƒç”¨åœ¨æ¯ä¸ªå¼‚æ­¥æ“ä½œçš„ä¸ç”¨ç”Ÿå‘½å‘¨æœŸä¸­

* åœ¨ä¸€ä¸ªèµ„æºçš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œå›è°ƒå‡½æ•° init()ã€before()ã€after()ã€destroy() ä¼šé’ˆå¯¹å„è‡ªç›¸åº”çš„å¼‚æ­¥äº‹ä»¶è¢«è°ƒç”¨

:::tip

* æ‰€æœ‰çš„å›è°ƒå‡½æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œæ€æƒ³çš„è¯æ˜¯å’Œæ¯”å¦‚è¯´ä¸€äº›æ‰“åŒ…çš„é…ç½®æˆ–è€…è¯´ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„ä½¿ç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯é€‰æ‹©

```javascript
const async_hooks = require("node:async_hooks")
const asyncHooksInstance = async_hooks.createHook({
    init(asyncId, type, triggerAsyncId, resource) {},
    destory(asyncId) {}
})
```

:::

:::details

* æ›´è¯¦ç»†çš„ä¾‹å­

```javascript
const async_hooks = require('node:async_hooks');

class MyAsyncCallback {
    init(asyncId, type, triggerAsyncId, resource) {}
    destroy(asyncId) {}
}

class MyAsyncCallbackWithAfter extends MyAsyncCallback {
    after(asyncId) {}
}

class MyAsyncCallbackWithBefore extends MyAsyncCallback {
    before(asyncId) {}
}

class MyAsyncCallbackWithPromiseResolve extends MyAsyncCallback {
    promiseResolve(asyncId) {}
}

class MyAsyncCallbackWithAll extends MyAsyncCallbackWithAfter {
    before(asyncId) {}
    after(asyncId) {}
    promiseResolve(asyncId) {}
}

const myAsyncCallbackWithAll = new MyAsyncCallbackWithAll();
const asyncHookInstanceAll = async_hooks.createHook(myAsyncCallbackWithAll);

module.exports = {
    myAsyncCallbackWithAll,
    asyncHookInstanceAll
}
```

:::

## `AsyncHookInstance.enable()`

* é¦–å…ˆä¸Šé¢çš„æ¡ˆä¾‹å·²ç»è¯´æ˜äº† craeetHook å®ç°çš„æ˜¯åˆ›å»ºå¯¹åº”çš„å®ä¾‹å‡ºæ¥çš„

* å¯¹äºå®ä¾‹çš„è¯ä¹Ÿæ˜¯æœ‰ä¸€äº›å®ä¾‹æ–¹æ³•çš„å‘

:::info

ä¸ºç»™å®šçš„ AsyncHook å®ä¾‹å¯ç”¨å›è°ƒã€‚å¦‚æœæ²¡æœ‰æä¾›å›è°ƒï¼Œå¯ç”¨æ“ä½œä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœã€‚
AsyncHook å®ä¾‹é»˜è®¤æ˜¯ç¦ç”¨çš„ã€‚å¦‚æœ AsyncHook å®ä¾‹åº”è¯¥åœ¨åˆ›å»ºåç«‹å³å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼

:::

## `AsyncHookInstance.disable()`

:::tip

ä»è¦æ‰§è¡Œçš„ AsyncHook å…¨å±€å›è°ƒæ± ä¸­ï¼Œç¦ç”¨ç»™å®š AsyncHook å®ä¾‹çš„å›è°ƒã€‚ä¸€æ—¦ä¸€ä¸ªé’©å­è¢«ç¦ç”¨ï¼Œåœ¨é‡æ–°å¯ç”¨ä¹‹å‰ï¼Œå®ƒå°†ä¸ä¼šå†è¢«è°ƒç”¨ã€‚
ä¸ºäº† API çš„ä¸€è‡´æ€§ï¼Œdisable() ä¹Ÿä¼šè¿”å›è¯¥ AsyncHook å®ä¾‹ã€‚

:::

## `Hook callbacks`

### `init`
:::info

å¼‚æ­¥äº‹ä»¶ç”Ÿå‘½å‘¨æœŸä¸­çš„å…³é”®äº‹ä»¶è¢«å½’ç±»ä¸ºå››ä¸ªæ–¹é¢ï¼šå®ä¾‹åŒ–ã€å›è°ƒè°ƒç”¨å‰/åï¼Œä»¥åŠå®ä¾‹é”€æ¯æ—¶ã€‚

* init(asyncId, type, triggerAsyncId, resource)
    * asyncId numberï¼šå¼‚æ­¥èµ„æºçš„å”¯ä¸€ IDã€‚
    * type stringï¼šå¼‚æ­¥èµ„æºçš„ç±»å‹ã€‚
    * triggerAsyncId numberï¼šåœ¨å…¶æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­åˆ›å»ºæ­¤å¼‚æ­¥èµ„æºçš„å¼‚æ­¥èµ„æºçš„å”¯ä¸€ IDã€‚
    * resource Objectï¼šè¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„èµ„æºçš„å¼•ç”¨ï¼Œéœ€è¦åœ¨ `destroy` æ—¶é‡Šæ”¾ã€‚

å½“æ„é€ ä¸€ä¸ªæœ‰å¯èƒ½å‘å‡ºå¼‚æ­¥äº‹ä»¶çš„ç±»æ—¶è°ƒç”¨ã€‚è¿™å¹¶ä¸æ„å‘³ç€å®ä¾‹å¿…é¡»åœ¨ `destroy` è¢«è°ƒç”¨å‰è°ƒç”¨ `before` / `after`ï¼Œåªæ˜¯å­˜åœ¨è¿™ç§å¯èƒ½æ€§ã€‚

è¿™ç§è¡Œä¸ºå¯ä»¥é€šè¿‡ç±»ä¼¼è¿™æ ·çš„æ“ä½œæ¥è§‚å¯Ÿï¼šæ‰“å¼€ä¸€ä¸ªèµ„æºï¼Œç„¶ååœ¨è¯¥èµ„æºå¯è¢«ä½¿ç”¨å‰å…³é—­å®ƒã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†è¿™ä¸€ç‚¹ã€‚

```javascript
require('node:net').createServer().listen(function() { this.close(); });
clearTimeout(setTimeout(() => {}, 10));
```

æ¯ä¸ªæ–°èµ„æºéƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªåœ¨å½“å‰ Node.js å®ä¾‹èŒƒå›´å†…å”¯ä¸€çš„ IDã€‚

:::

:::details

* `type`
    * type æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæ ‡è¯†å¯¼è‡´ init è¢«è°ƒç”¨çš„èµ„æºç±»å‹ã€‚é€šå¸¸ï¼Œå®ƒä¸èµ„æºæ„é€ å‡½æ•°çš„åç§°ç›¸å¯¹åº”ã€‚
    * Node.js è‡ªèº«åˆ›å»ºçš„èµ„æºçš„ type åœ¨ Node.js çš„ä»»ä½•ç‰ˆæœ¬ä¸­éƒ½å¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚æœ‰æ•ˆçš„å€¼åŒ…æ‹¬ TLSWRAPã€TCPWRAPã€TCPSERVERWRAPã€GETADDRINFOREQWRAPã€FSREQCALLBACKã€Microtask å’Œ Timeoutã€‚è¦è·å–å®Œæ•´åˆ—è¡¨ï¼Œè¯·æŸ¥çœ‹æ‰€ä½¿ç”¨çš„ Node.js ç‰ˆæœ¬çš„æºä»£ç ã€‚
    * æ­¤å¤–ï¼ŒAsyncResource çš„ç”¨æˆ·å¯ä»¥ç‹¬ç«‹äº Node.js è‡ªèº«åˆ›å»ºå¼‚æ­¥èµ„æºã€‚
    * è¿˜æœ‰ PROMISE èµ„æºç±»å‹ï¼Œç”¨äºè·Ÿè¸ª Promise å®ä¾‹ä»¥åŠç”±å®ƒä»¬è°ƒåº¦çš„å¼‚æ­¥å·¥ä½œã€‚
    * å½“ä½¿ç”¨å…¬å…±åµŒå…¥å™¨ API æ—¶ï¼Œç”¨æˆ·èƒ½å¤Ÿå®šä¹‰è‡ªå·±çš„ typeã€‚
    * å¯èƒ½ä¼šå‡ºç°ç±»å‹åç§°å†²çªçš„æƒ…å†µã€‚å»ºè®®åµŒå…¥å™¨ä½¿ç”¨å”¯ä¸€çš„å‰ç¼€ï¼ˆä¾‹å¦‚ npm åŒ…åç§°ï¼‰ï¼Œä»¥é˜²æ­¢åœ¨ç›‘å¬é’©å­æ—¶å‘ç”Ÿå†²çªã€‚

* `triggerAsyncId`
    * triggerAsyncId æ˜¯å¯¼è‡´ï¼ˆæˆ– â€œè§¦å‘â€ï¼‰æ–°èµ„æºåˆå§‹åŒ–å¹¶ä½¿å¾— init è¢«è°ƒç”¨çš„èµ„æºçš„ asyncIdã€‚è¿™ä¸ async_hooks.executionAsyncId() ä¸åŒï¼Œasync_hooks.executionAsyncId() ä»…æ˜¾ç¤ºèµ„æºä½•æ—¶è¢«åˆ›å»ºï¼Œè€Œ triggerAsyncId æ˜¾ç¤ºèµ„æºä¸ºä½•è¢«åˆ›å»ºã€‚

:::

## Each Callback 

:::info

| å›è°ƒå‡½æ•°         | è§¦å‘æ—¶æœº                                                                 | æ ¸å¿ƒå‚æ•°                                                                 | æ ¸å¿ƒä½œç”¨                                                                 | å…¸å‹åº”ç”¨åœºæ™¯                                                                 |
|------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|------------------------------------------------------------------------------|
| `init`           | å¼‚æ­¥èµ„æºåˆå§‹åŒ–æ—¶è§¦å‘ï¼ˆå¦‚åˆ›å»º Promiseã€å®šæ—¶å™¨ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰               | `asyncId`ï¼ˆå½“å‰èµ„æºå”¯ä¸€IDï¼‰ã€`type`ï¼ˆèµ„æºç±»å‹ï¼‰ã€`triggerAsyncId`ï¼ˆè§¦å‘è€…IDï¼‰ã€`resource`ï¼ˆèµ„æºå¯¹è±¡ï¼‰ | è®°å½•å¼‚æ­¥èµ„æºçš„åˆ›å»ºä¿¡æ¯ï¼Œå»ºç«‹èµ„æºé—´çš„å…³è”å…³ç³»ï¼ˆå¦‚çˆ¶å­è°ƒç”¨é“¾ï¼‰             | ç”Ÿæˆè¿½è¸ªIDï¼ˆtraceIdï¼‰ã€è®°å½•èµ„æºç±»å‹/åˆ›å»ºæ—¶é—´ã€åˆå§‹åŒ–ä¸Šä¸‹æ–‡å­˜å‚¨               |
| `before`         | å¼‚æ­¥èµ„æºçš„å›è°ƒå‡½æ•°æ‰§è¡Œå‰è§¦å‘ï¼ˆè‹¥èµ„æºæœ‰å¤šä¸ªå›è°ƒï¼Œä¼šå¤šæ¬¡è§¦å‘ï¼‰             | `asyncId`ï¼ˆå½“å‰èµ„æºIDï¼‰                                                 | å‡†å¤‡å›è°ƒæ‰§è¡Œçš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œæ¢å¤ä¹‹å‰ä¿å­˜çš„çŠ¶æ€                             | æ³¨å…¥æ—¥å¿—ä¸Šä¸‹æ–‡ï¼ˆå¦‚è¯·æ±‚IDï¼‰ã€æ€§èƒ½ç›‘æ§çš„â€œå¼€å§‹è®¡æ—¶â€                             |
| `after`          | å¼‚æ­¥èµ„æºçš„å›è°ƒå‡½æ•°æ‰§è¡Œåç«‹å³è§¦å‘ï¼ˆè‹¥å›è°ƒæŠ›é”™ï¼Œåœ¨ `uncaughtException` åè§¦å‘ï¼‰ | `asyncId`ï¼ˆå½“å‰èµ„æºIDï¼‰                                                 | æ¸…ç†å›è°ƒæ‰§è¡Œåçš„ä¸´æ—¶çŠ¶æ€ï¼Œè®°å½•æ‰§è¡Œç»“æœ                                   | æ€§èƒ½ç›‘æ§çš„â€œç»“æŸè®¡æ—¶å¹¶è®¡ç®—è€—æ—¶â€ã€æ¸…ç†ä¸´æ—¶å˜é‡é¿å…å†…å­˜æ³„æ¼                       |
| `destroy`        | å¼‚æ­¥èµ„æºè¢«é”€æ¯æ—¶è§¦å‘ï¼ˆä¾èµ–åƒåœ¾å›æ”¶ï¼Œå¯èƒ½å› å†…å­˜æ³„æ¼ä¸è§¦å‘ï¼‰               | `asyncId`ï¼ˆå½“å‰èµ„æºIDï¼‰                                                 | é‡Šæ”¾èµ„æºå…³è”çš„æŒä¹…åŒ–æ•°æ®ï¼Œç¡®ä¿èµ„æºå®Œå…¨å›æ”¶                               | æ¸…ç†ä¸èµ„æºç»‘å®šçš„ç¼“å­˜/è¿æ¥ã€è®°å½•èµ„æºç”Ÿå‘½å‘¨æœŸå®Œæ•´æ—¥å¿—                           |
| `promiseResolve` | Promise çš„ `resolve` è¢«è°ƒç”¨æ—¶è§¦å‘ï¼ˆåŒ…æ‹¬ `.then` éšå¼åˆ›å»ºçš„ Promiseï¼‰      | `asyncId`ï¼ˆå½“å‰ Promise çš„IDï¼‰                                          | è¿½è¸ª Promise è§£æè¿‡ç¨‹ï¼Œè¡¥å…¨å¼‚æ­¥é“¾ä¸­ Promise ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸ               | å®Œå–„ Promise å¼‚æ­¥æµçš„è¿½è¸ªï¼ˆå› åŸç”Ÿ `async_hooks` å¯¹ Promise æ”¯æŒéœ€æ˜¾å¼å¤„ç†ï¼‰ |

> demo:

```javascript
const async_hooks = require('node:async_hooks');

// åˆ›å»ºé’©å­å®ä¾‹
// å®šä¹‰æˆ‘ä»¬å…³å¿ƒçš„èµ„æºç±»å‹
const interestedTypes = new Set(['Timeout', 'Promise']);

// é™åˆ¶æ—¥å¿—è¾“å‡ºæ•°é‡
let logCount = 0;
const maxLogs = 50;

// å®‰å…¨çš„æ—¥å¿—å‡½æ•°
function safeLog(...args) {
  if (logCount < maxLogs) {
    // ä½¿ç”¨åŸå§‹çš„process.stdout.writeé¿å…è§¦å‘æ›´å¤šå¼‚æ­¥é’©å­
    process.stdout.write(args.join(' ') + '\n');
    logCount++;
  }
}

const hook = async_hooks.createHook({
  init(asyncId, type, triggerAsyncId, resource) {
    // åªè®°å½•æˆ‘ä»¬å…³å¿ƒçš„èµ„æºç±»å‹
    if (interestedTypes.has(type)) {
      safeLog(`[init] èµ„æºç±»å‹: ${type}, ID: ${asyncId}, è§¦å‘è€…ID: ${triggerAsyncId}`);
    }
  },
  before(asyncId) {
    // beforeäº‹ä»¶é€šå¸¸ä¸åšè¿‡æ»¤
    safeLog(`[before] èµ„æº ${asyncId} çš„å›è°ƒå³å°†æ‰§è¡Œ`);
  },
  after(asyncId) {
    // afteräº‹ä»¶é€šå¸¸ä¸åšè¿‡æ»¤
    safeLog(`[after] èµ„æº ${asyncId} çš„å›è°ƒæ‰§è¡Œå®Œæˆ`);
  },
  destroy(asyncId) {
    // destroyäº‹ä»¶é€šå¸¸ä¸åšè¿‡æ»¤
    safeLog(`[destroy] èµ„æº ${asyncId} å·²é”€æ¯`);
  },
  promiseResolve(asyncId) {
    // åªè®°å½•Promiseè§£æäº‹ä»¶
    safeLog(`[promiseResolve] Promise ${asyncId} å·²è§£æ`);
  }
});

// å¯ç”¨é’©å­
hook.enable();

// æµ‹è¯•å¼‚æ­¥èµ„æºï¼ˆå®šæ—¶å™¨ï¼‰
setTimeout(() => {
  process.stdout.write('å®šæ—¶å™¨å›è°ƒæ‰§è¡Œ\n');
  
  // 3ç§’åç¦ç”¨é’©å­å¹¶é€€å‡ºè¿›ç¨‹
  setTimeout(() => {
    process.stdout.write('æ¼”ç¤ºå®Œæˆï¼Œç¦ç”¨é’©å­å¹¶é€€å‡º\n');
    hook.disable();
    process.exit(0);
  }, 3000);
}, 100);

// æµ‹è¯•Promise
Promise.resolve().then(() => {
  process.stdout.write('Promiseå›è°ƒæ‰§è¡Œ\n');
});
```

* è¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„ `console.log()` çš„è¯æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥èµ„æºå‡½æ•°ï¼Œæ‰€ä»¥è¯´åœ¨è¿›è¡Œæ—¥å¿—ç­”åº”çš„æ—¶å€™ä¼šå‡ºç°å¼‚æ­¥èµ„æºå›è°ƒçš„å¾ªç¯è§¦å‘
* æ‰€ä»¥è¯´å¯¹äºå®˜æ–¹çš„æ¡ˆä¾‹ä»¥åŠæˆ‘ä»¬çš„æµ‹è¯•æ¡ˆä¾‹å®è·µç­”åº”ä¸»è¦æ˜¯ç”¨çš„ï¼š`process.stdout.write()` è¿›è¡Œçš„ç­”åº”å§
* ä»¥åŠåœ¨ async_hooks å†…çš„å†…éƒ¨çš„ callback çš„è¯å°½å¯èƒ½ä¸è¦å‡ºç°å¼‚æ­¥çš„æ‰§è¡Œå‡½æ•°å§ï¼Œå°½å¯èƒ½ä½¿ç”¨åŒæ­¥çš„æ“ä½œå®ç°

:::

:::details

* `TCPSERVERWRAP`: å°±æ˜¯æ¥æ”¶åˆ°è¿æ¥çš„æœåŠ¡å™¨ç±»å‹
* `TCPWRAP`: æ¥è‡ªäºå®¢æˆ·ç«¯æ–°çš„è¿æ¥ï¼Œå½“ä¸€ä¸ªæ–°çš„è¿æ¥è¿›æ¥ï¼Œé‚£ä¹ˆTCPWrap å®ä¾‹ç«‹å³è¢«åˆ›å»º

```
  root(1)
     ^
     |
TickObject(6)
     ^
     |
 Timeout(7)
```

```
 bootstrap(1)
     |
     Ë…
TCPSERVERWRAP(5)
     |
     Ë…
 TickObject(6)
     |
     Ë…
  Timeout(7)
```

* å°½ç®¡ `TCPSERVERWRAP` æ˜¯è°ƒç”¨ `console.log()` çš„åŸå› ï¼Œä½†å®ƒå¹¶æœªå‡ºç°åœ¨æ­¤å›¾ä¸­ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä¸æŒ‡å®šä¸»æœºåçš„æƒ…å†µä¸‹ç»‘å®šç«¯å£æ˜¯ä¸€ä¸ªåŒæ­¥æ“ä½œï¼Œä¸è¿‡ä¸ºäº†ç»´æŒå®Œå…¨å¼‚æ­¥çš„ APIï¼Œç”¨æˆ·çš„å›è°ƒå‡½æ•°ä¼šè¢«æ”¾å…¥ `process.nextTick()` ä¸­ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `TickObject` ä¼šå‡ºç°åœ¨è¾“å‡ºä¸­ï¼Œå¹¶ä¸”æ˜¯ `.listen()` å›è°ƒå‡½æ•°çš„çˆ¶çº§ã€‚

:::

:::tip

è¿™å¥è¯æ ¸å¿ƒæƒ³è¡¨è¾¾çš„æ˜¯ **Node.js å†…éƒ¨å¯¹â€œåŒæ­¥æ“ä½œçš„å¼‚æ­¥ API å°è£…é€»è¾‘â€**ï¼Œå…·ä½“å¯ä»¥æ‹†è§£ä¸ºä¸¤å±‚æ„æ€ï¼š

1. **è¡¨é¢ç°è±¡**ï¼š  
   TCPSERVERWRAPï¼ˆNode.js å†…éƒ¨å¤„ç† TCP æœåŠ¡å™¨çš„åº•å±‚å¯¹è±¡ï¼‰æ˜æ˜æ˜¯è§¦å‘ console.log() çš„æºå¤´ï¼Œå´æ²¡å‡ºç°åœ¨å¼‚æ­¥è°ƒç”¨å…³ç³»å›¾é‡Œï¼›åè€Œ TickObject å‡ºç°åœ¨å›¾ä¸­ï¼Œè¿˜ä½œä¸º .listen() å›è°ƒçš„â€œçˆ¶çº§â€ã€‚

2. **æ·±å±‚åŸå› **ï¼š  
   å½“è°ƒç”¨ TCP æœåŠ¡å™¨çš„ .listen() æ–¹æ³•ä¸”ä¸æŒ‡å®šä¸»æœºåæ—¶ï¼Œâ€œç»‘å®šç«¯å£â€è¿™ä¸ªæ“ä½œæœ¬èº«æ˜¯**åŒæ­¥**å®Œæˆçš„ã€‚ä½† Node.js ä¸ºäº†å¯¹å¤–æš´éœ²**ç»Ÿä¸€çš„å¼‚æ­¥ API ä½“éªŒ**ï¼ˆé¿å…åŒæ­¥æ“ä½œé˜»å¡äº‹ä»¶å¾ªç¯ï¼‰ï¼Œä¼šæŠŠç”¨æˆ·ä¼ å…¥çš„ .listen() å›è°ƒå‡½æ•°ï¼Œé€šè¿‡ process.nextTick() æ”¾åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„â€œå¾®ä»»åŠ¡é˜Ÿåˆ—â€ä¸­æ‰§è¡Œã€‚  
   è¿™å°±å¯¼è‡´ï¼šåŸæœ¬åŒæ­¥çš„æ“ä½œè¢«åŒ…è£…æˆäº†å¼‚æ­¥æ‰§è¡Œé€»è¾‘ï¼Œè€Œ TickObject æ­£æ˜¯ process.nextTick() äº§ç”Ÿçš„å†…éƒ¨å¯¹è±¡ï¼Œå› æ­¤åœ¨å¼‚æ­¥è°ƒç”¨é“¾ä¸­ï¼Œå®ƒæˆäº† .listen() å›è°ƒçš„ç›´æ¥â€œçˆ¶çº§â€ï¼Œæ›¿ä»£äº†å®é™…è§¦å‘æ“ä½œçš„ TCPSERVERWRAP å‡ºç°åœ¨è°ƒç”¨å…³ç³»é‡Œã€‚

ç®€å•è¯´å°±æ˜¯ï¼šNode.js ç”¨ process.nextTick() æŠŠä¸€ä¸ªâ€œåŒæ­¥æ“ä½œçš„ç»“æœâ€å¼ºè¡Œå¡è¿›äº†å¼‚æ­¥æµç¨‹ï¼Œç›®çš„æ˜¯ä¿è¯ API è¡Œä¸ºçš„ä¸€è‡´æ€§ï¼ˆå¯¹å¤–å§‹ç»ˆè¡¨ç°ä¸ºå¼‚æ­¥ï¼‰ï¼Œè¿™æ‰é€ æˆäº†è°ƒç”¨å…³ç³»å›¾é‡Œçš„â€œçœ‹ä¼¼çŸ›ç›¾â€çš„ç°è±¡ã€‚

:::

## `AsyncLocalStorage` AND `AsyncResource`

### æ ¸å¿ƒæ¦‚å¿µæ€»ç»“

#### AsyncLocalStorage
- ç”¨äºåœ¨å¼‚æ­¥æ“ä½œé“¾ä¸­å…±äº«çŠ¶æ€çš„æœºåˆ¶ï¼Œæ— éœ€é€šè¿‡å‚æ•°ä¼ é€’ä¸Šä¸‹æ–‡ï¼ˆå¦‚è¯·æ±‚IDã€ç”¨æˆ·ä¿¡æ¯ç­‰ï¼‰
- åŸºäºå¼‚æ­¥èµ„æºç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç»‘å®šä¸Šä¸‹æ–‡ï¼Œæ”¯æŒåµŒå¥—å¼‚æ­¥æ“ä½œï¼ˆPromiseã€å®šæ—¶å™¨ã€I/Oç­‰ï¼‰
- æ ¸å¿ƒåŸç†ï¼šå€ŸåŠ© `async_hooks` è¿½è¸ªå¼‚æ­¥èµ„æºåˆ›å»º/æ‰§è¡Œæ—¶æœºï¼Œè‡ªåŠ¨å…³è”å’Œåˆ‡æ¢ä¸Šä¸‹æ–‡

#### AsyncResource
- æ‰‹åŠ¨åˆ›å»ºå¼‚æ­¥èµ„æºçš„å·¥å…·ç±»ï¼Œç”¨äºåŒ…è£…åŸç”Ÿ `async_hooks` æœªè¦†ç›–çš„è‡ªå®šä¹‰å¼‚æ­¥æ“ä½œ
- å…è®¸ä¸ºè‡ªå®šä¹‰å¼‚æ­¥æ“ä½œæ³¨å…¥ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä½¿å…¶å¯è¢« `async_hooks` è¿½è¸ª
- å¸¸ä¸ `AsyncLocalStorage` é…åˆï¼Œç¡®ä¿è‡ªå®šä¹‰å¼‚æ­¥æ“ä½œèƒ½å…±äº«ä¸Šä¸‹æ–‡

### APIæ–‡æ¡£æ€»ç»“

#### AsyncLocalStorage API

| æ–¹æ³•                | æè¿°                                                                 |
|---------------------|----------------------------------------------------------------------|
| `new AsyncLocalStorage()` | åˆ›å»ºå®ä¾‹                                                             |
| `run(context, callback)`  | è¿è¡Œå›è°ƒå‡½æ•°ï¼Œä¸ºå½“å‰åŠåç»­å¼‚æ­¥æ“ä½œç»‘å®š `context`                      |
| `enterWith(context)`     | ä¸ºå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡ç»‘å®š `context`ï¼ˆæ— éœ€åŒ…è£¹å›è°ƒï¼Œæ…ç”¨ï¼‰                  |
| `getStore()`             | è·å–å½“å‰ä¸Šä¸‹æ–‡çš„ `context`ï¼Œæ— ä¸Šä¸‹æ–‡æ—¶è¿”å› `undefined`                |
| `disable()`              | ç¦ç”¨å®ä¾‹ï¼Œé‡Šæ”¾å†…éƒ¨èµ„æºï¼ˆè°ƒç”¨åæ— æ³•å†ä½¿ç”¨ï¼‰                            |

#### AsyncResource API

| æ–¹æ³•/å±æ€§                | æè¿°                                                                 |
|--------------------------|----------------------------------------------------------------------|
| `new AsyncResource(type, options)` | åˆ›å»ºå®ä¾‹ï¼Œ`type` ä¸ºèµ„æºç±»å‹ï¼ˆå¦‚ 'MY_CUSTOM_ASYNC'ï¼‰ï¼Œ`options` å«å¯é€‰é…ç½®ï¼ˆå¦‚ `triggerAsyncId`ï¼‰ |
| `runInAsyncScope(callback, thisArg, ...args)` | åœ¨å½“å‰èµ„æºä¸Šä¸‹æ–‡å†…æ‰§è¡Œå›è°ƒï¼Œç¡®ä¿ `async_hooks` å¯è¿½è¸ªæ­¤æ“ä½œ          |
| `emitDestroy()`          | æ‰‹åŠ¨è§¦å‘èµ„æºçš„ `destroy` é’©å­ï¼ˆéœ€é…åˆ `async_hooks` ä½¿ç”¨ï¼‰            |
| `asyncId`                | èµ„æºçš„å”¯ä¸€IDï¼ˆåªè¯»ï¼‰                                                 |
| `triggerAsyncId`         | è§¦å‘å½“å‰èµ„æºçš„çˆ¶çº§èµ„æºIDï¼ˆåªè¯»ï¼‰                                     |

### ä½¿ç”¨æŒ‡å—æ€»ç»“

#### AsyncLocalStorage ä½¿ç”¨æ­¥éª¤
1. åˆ›å»ºå®ä¾‹ï¼š`const als = new AsyncLocalStorage();`
2. ç»‘å®šä¸Šä¸‹æ–‡ï¼šç”¨ `als.run(context, () => { ... })` åŒ…è£¹åˆå§‹åŒæ­¥/å¼‚æ­¥æ“ä½œ
3. è·å–ä¸Šä¸‹æ–‡ï¼šåœ¨ä»»æ„åµŒå¥—çš„å¼‚æ­¥å›è°ƒä¸­é€šè¿‡ `als.getStore()` è·å– `context`
4. æ³¨æ„äº‹é¡¹ï¼š
   - é¿å…åœ¨ `run` å¤–éƒ¨è°ƒç”¨ `enterWith`ï¼ˆå¯èƒ½å¯¼è‡´ä¸Šä¸‹æ–‡æ··ä¹±ï¼‰
   - ä»…å¯¹å¼‚æ­¥æ“ä½œæœ‰æ•ˆï¼Œä¸æ”¯æŒåŒæ­¥ä»£ç å—é—´çš„ä¸Šä¸‹æ–‡éš”ç¦»

#### AsyncResource ä½¿ç”¨æ­¥éª¤
1. åˆ›å»ºèµ„æºï¼š`const resource = new AsyncResource('MY_RESOURCE');`
2. åŒ…è£…å¼‚æ­¥æ“ä½œï¼šç”¨ `resource.runInAsyncScope(() => { ... })` æ‰§è¡Œè‡ªå®šä¹‰å¼‚æ­¥é€»è¾‘
3. ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼šå¿…è¦æ—¶è°ƒç”¨ `resource.emitDestroy()` é‡Šæ”¾èµ„æº
4. æ³¨æ„äº‹é¡¹ï¼š
   - `type` å»ºè®®éµå¾ª Node.js èµ„æºå‘½åè§„èŒƒï¼ˆå¦‚ 'TCPWRAP'ã€'PROMISE'ï¼‰
   - é…åˆ `async_hooks` æ—¶éœ€æ³¨å†Œé’©å­ç›‘å¬èµ„æºç”Ÿå‘½å‘¨æœŸ

### æ¡ˆä¾‹Demoæ€»ç»“

#### AsyncLocalStorageï¼šHTTPè¯·æ±‚ä¸Šä¸‹æ–‡è¿½è¸ª
```javascript
const http = require('http');
const { AsyncLocalStorage } = require('async_hooks');

const als = new AsyncLocalStorage();

// æ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®åº“æŸ¥è¯¢
function fetchData() {
  const requestId = als.getStore(); // è·å–å½“å‰è¯·æ±‚ID
  return new Promise(resolve => {
    setTimeout(() => {
      resolve(`æ•°æ®ç»“æœï¼ˆè¯·æ±‚IDï¼š${requestId}ï¼‰`);
    }, 100);
  });
}

const server = http.createServer((req, res) => {
  const requestId = Date.now().toString(); // ç”Ÿæˆå”¯ä¸€è¯·æ±‚ID
  als.run(requestId, async () => {
    const data = await fetchData();
    res.end(`[${als.getStore()}] ${data}`); // å“åº”ä¸­åŒ…å«è¯·æ±‚ID
  });
});

server.listen(3000, () => {
  console.log('æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:3000');
});
```

## AsyncResource With worker

:::note

- åŸºç¡€ä½¿ç”¨

> åˆæ­¥éªŒè¯ AsyncResource å’Œ Worker çº¿ç¨‹çš„åŸºç¡€åä½œèƒ½åŠ›å®ç°

> è®©ä¸»çº¿ç¨‹èƒ½é€šè¿‡ `AsyncResource` æœ€ç»ˆworkerå›è°ƒçš„å¼‚æ­¥ä¸Šä¸‹æ–‡ï¼Œå»ºç«‹è·¨çº¿ç¨‹çš„å¼‚æ­¥å…³è”

```javascript
const { worker } = require('node:worker_threads');
const { AsyncResource } = require('node:async_hooks');

// 1. åˆ›å»ºå­çº¿ç¨‹
const child_worker = new worker('./worker/child_worker.js')
// 2. ä½¿ç”¨AsyncResource è¿›è¡Œå®ç°åŒ…è£…Workerä¸­çš„messageå›è°ƒï¼Œå®ç°ä¸»çº¿ç¨‹çš„å¼‚æ­¥è¿½è¸ª tracking
const resource = new AsyncResource('BASIC_WORKER');

child_worker.on('message', resource.runInAsyncScope(msg => {
    console.log('ä¸»çº¿ç¨‹æ¥å—åˆ°çš„æ¶ˆæ¯', msg);
    resource.emitDestroy();  // èµ„æºé‡Šæ”¾
}))

// 3. å®ç°å‘å­çº¿ç¨‹è¿›è¡Œå‘é€ä¿¡æ¯
child_worker.postMessage('è¯·å¤„ç†æˆ‘ç»™ä½ åˆ†å‘çš„ä»»åŠ¡å“ˆï¼ï¼ï¼')

// =========./worker/child_worker.js==========
const { parentPort } = require('node:worker_threads');
parentPort.on('message', task => {
    setTimeout(() => {
        parentPort.postMessage(`å·²å®Œæˆï¼š${task}`);
    }, 100);
})
```
> **ä½†æ˜¯ç°åœ¨è¿™ä¸ªé˜¶æ®µåªæ˜¯å®Œæˆäº†ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹ä¹‹é—´çš„æ¶ˆæ¯é€šä¿¡ï¼Œä½†æ˜¯åœ¨é€šä¿¡çš„æ—¶å€™è¿›è¡Œcontextçš„ä¼ é€’æ²¡æœ‰å®ç°å‘**

- è§£å†³çº¿ç¨‹é—´çš„ä¸Šä¸‹æ–‡é€šä¿¡é—®é¢˜

> æ ¸å¿ƒä½¿ç”¨ `AsyncLocalStorage` è¿›è¡Œä¸»çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œå®ç°ä¸Šä¸‹æ–‡çš„æ•°æ®å…³è”

```javascript

const { worker } = require('node:worker_threads');
const { AsyncResource, AsyncLocalStorage } = require('node:async_hooks');

// 1. åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç®¡ç†å®¹å™¨
const als = new AsyncLocalStorage();

// 2. å®ç°å¯ä»¥ä¸Šä¸‹æ–‡ç›´æ¥ä¼ é€’çš„å·¥å…·å‡½æ•°
function runTaskWithContext(task) {
    return new Promise((resolve, reject) => {
        try {
            const child_worker = new worker('./worker/child_worker.js');
            const resource = new AsyncResource('WITH_CONTEXT_WORKER');
            child_worker.on('message', resource.runInAsyncScope(res => {
                // åœ¨æ­¤æ—¶è·å–å¾—åˆ°å¯¹åº”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å§
                resolve({
                    ...res,
                    mainContext: als.getStore()
                })
                resource.emitDestroy();  // èµ„æºåŠæ—¶é‡Šæ”¾
            }))

            child_worker.postMessage({
                task,
                context: als.getStore()
            })
        }
        catch (error) {
            reject(error);
        }
    })
}

// 3. ä¸»çº¿ç¨‹æ‰§è¡Œä¸Šä¸‹æ–‡
als.run({
    // å®é™…å¯ä»¥é€šè¿‡ uuid ç”Ÿæˆ traceId å§
    traceId: 't1111',
    async () => {
        const res = await runTaskWithContext('è¿™æ˜¯è¿½è¸ªIDçš„å°è£…å§'),
        console.log(`[${result.mainContext.traceId}] æœ€ç»ˆç»“æœï¼š`, result.taskResult);
    }
})

// ==================
const { parentPort } = require('worker_threads');
parentPort.on('message', ({ task, context }) => {
    setTimeout(() => {
        // å¤„ç†ä»»åŠ¡å¹¶å›ä¼ ä¸Šä¸‹æ–‡
        parentPort.postMessage({
            taskResult: `å¤„ç†å®Œæˆï¼š${task}`,
            workerContext: context // ä¿ç•™ä¸»çº¿ç¨‹ä¼ é€’çš„ä¸Šä¸‹æ–‡
        });
    }, 100);
});
```
> ä½¿ç”¨çš„æ˜¯`AsyncLocalStorage`å®ç°å­˜å‚¨ä¸»çº¿ç¨‹çš„ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ï¼Œè§£å†³å¼‚æ­¥ä¸Šä¸‹æ–‡çš„ä¼ é€’é—®é¢˜å§

> æœ€åé€šè¿‡ `postMessage` è¿›è¡Œå®ç°æ˜¾ç¤ºçš„ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œçªç ´ Worker ä¸ä¸»çº¿ç¨‹çš„å†…å­˜éš”ç¦»é™åˆ¶ï¼Œå®ç°è·¨çº¿ç¨‹æ•°æ®å…³è”

> **ä½†æ˜¯ç°åœ¨è¿˜å…·å¤‡ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬çš„async_hookså™¨åªèƒ½è¿½è¸ªè‡ªèº«æ‰€åœ¨çº¿ç¨‹çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå­çº¿ç¨‹çš„è¿½è¸ªä¸äº†ï¼Œä½†æ˜¯æ ¸å¿ƒçš„è¯æ˜¯å’Œä¸Šä¸€é˜¶æ®µæ˜¯ä¸€æ ·å‘¢**

- å®ç°å­çº¿ç¨‹å¼‚æ­¥è¿½è¸ª

> æ ¸å¿ƒå°±æ˜¯åœ¨å­çº¿ç¨‹ä¸­å¤„ç†çš„æ—¶å€™ä¹Ÿè¿›è¡Œå¯¹åº”çš„ asyncResource çš„èµ„æºç®¡ç†å§

```javascript
const { worker } = require('node:worker_threads');
const { AsyncResource, AsyncLocalStorage } = require('node:async_hooks');

// 1. åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç®¡ç†å®¹å™¨
const als = new AsyncLocalStorage();

// 2. å®ç°å¯ä»¥ä¸Šä¸‹æ–‡ç›´æ¥ä¼ é€’çš„å·¥å…·å‡½æ•°
function runTaskWithContext(task) {
    return new Promise((resolve, reject) => {
        try {
            const child_worker = new worker('./worker/child_worker.js');
            const resource = new AsyncResource('WITH_CONTEXT_WORKER');
            child_worker.on('message', resource.runInAsyncScope(res => {
                // åœ¨æ­¤æ—¶è·å–å¾—åˆ°å¯¹åº”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å§
                resolve({
                    ...res,
                    mainContext: als.getStore()
                })
                resource.emitDestroy();  // èµ„æºåŠæ—¶é‡Šæ”¾
            }))

            child_worker.postMessage({
                task,
                context: als.getStore()
            })
        }
        catch (error) {
            reject(error);
        }
    })
}

// 3. ä¸»çº¿ç¨‹æ‰§è¡Œä¸Šä¸‹æ–‡
als.run({
    // å®é™…å¯ä»¥é€šè¿‡ uuid ç”Ÿæˆ traceId å§
    traceId: 't1111',
    async () => {
        const res = await runTaskWithContext('è¿™æ˜¯è¿½è¸ªIDçš„å°è£…å§'),
        console.log(`[${result.mainContext.traceId}] æœ€ç»ˆç»“æœï¼š`, result.taskResult);
    }
})

// ==================
const { parentPort } = require('worker_threads');
const { AsyncResource } = require('async_hooks');

function processTaskWithAsync(task, context) {
    return new Promise((resolve, reject) => {
        try {
            const resource = new AsyncResource('WORKER_INNER_TASK');
            setTimeout(resource.runInAsyncScope(() => {
                resolve('', task);
                resource.emitDestroy();
            }))
        }
        catch(error) {
            reject(error)
        }
    })
}

parentPort.on('message', ({ task, context }) => {
    const result = await processTaskAsync(task, context);
    parentPort.postMessage({ taskResult: result, workerContext: context });
});
```
> æ ¸å¿ƒå°±æ˜¯ä½¿ç”¨æˆ‘ä»¬çš„ `AsyncResource` è¿›è¡ŒåŒ…è£…å­çº¿ç¨‹çš„å¼‚æ­¥æ“çºµï¼Œä»è€Œå®ç°æœ€åçš„çš„å¼‚æ­¥è·Ÿè¸ªé“¾çš„å®ç°å§

* å·¥å…·å°è£…

```javascript
class WorkerManager {
    constructor(workerFilePath, asyncResourceName, maxWorkers = 3) {
        this.workerPath = workerFilePath;
        this.asyncResourceName = asyncResourceName;
        this.als = new AsyncLocalStorage();
        this.workerPool = [];
        this.maxWorkers = maxWorkers;  // æœ€å¤§å¹¶å‘æ•°
    }

    _getWorker() {
        if (this.workerPool.length < this.maxWorkers) {
            const worker = new Worker(this.workerPath);
            worker.isBusy = false;  // æ ‡è®°å½“å‰çš„çŠ¶æ€
            this.workerPool.push(worker);
            return worker;
        }
        // ç›´æ¥è¿”å›ç¬¬ä¸€ä¸ªä¸å¿™çš„worker
        return this.workerPool.find(w => !w.isBusy)
    }

    execute(task, context) {
        return this.als.run(context, () => {
            this._runWorker(task);
        })
    }

    _runWorker(task) {
        return new Promise((resolve, reject) => {
            const worker = this._getWorker();
            worker.isBusy = true;  // ç›´æ¥æ ‡è®°ä¸ºå¿™ç¢Œçš„ Worker
            const resource = new AsyncResource(this.asyncResourceName);

            // å¼‚å¸¸å¤„ç†
            const errorHandle = (err) => {
                resource.runInAsyncScope(() => {
                    reject('Worker Inner Error', err.message);
                })
                resource.emitDestroy();
                worker.isBusy = false;  // worker ç½®é—²
            }
            worker.once('error', errorHandle);

            // æ¶ˆæ¯å¤„ç†
            worker.once('message', resource.runInAsyncScope(res => {
                worker.isBusy = false;
                if (res.error) {
                    reject(res.error);
                }
                else {
                    resolve({
                        ...res,
                        mainContext: this.als.getStore();
                    })
                }
                resource.emitDestroy();
                worker.removeListener('error', errorHandle);
            }))

            worker.postMessage({
                task,
                context: this.als.getStore();
            })
        })
    }
}
```

:::

:::tip

- **æ ¸å¿ƒçŸ¥è¯†ç‚¹**
  - çº¿ç¨‹éš”ç¦»æ€§ï¼šWorker çº¿ç¨‹ä¸ä¸»çº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„äº‹ä»¶å¾ªç¯å’Œå†…å­˜ç©ºé—´ï¼Œ`async_hooks` çš„è¿½è¸ªèƒ½åŠ›æ— æ³•è·¨çº¿ç¨‹ç©¿é€ï¼Œ`AsyncResource` ä»…èƒ½ç®¡ç†å½“å‰çº¿ç¨‹å†…çš„å¼‚æ­¥èµ„æºã€‚
  - ä¸Šä¸‹æ–‡ä¼ é€’æ–¹å¼ï¼šä¸»çº¿ç¨‹ä¸ Worker é—´çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚è¿½è¸ª IDã€ç”¨æˆ·ä¿¡æ¯ç­‰ï¼‰éœ€é€šè¿‡ `postMessage` æ˜¾å¼ä¼ é€’ï¼Œæ— æ³•ä¾èµ– `AsyncLocalStorage` è‡ªåŠ¨å…±äº«ã€‚
  - èµ„æºå…³è”é€»è¾‘ï¼šåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œå¯ç”¨ `AsyncResource` åŒ…è£… Worker çš„ `message` å›è°ƒï¼Œå°† Worker å›è°ƒä¸ä¸»çº¿ç¨‹çš„å¼‚æ­¥ä¸Šä¸‹æ–‡å…³è”ï¼›Worker å†…éƒ¨çš„å¼‚æ­¥æ“ä½œåˆ™éœ€å•ç‹¬ç”¨ `AsyncResource` æ ‡è®°ï¼Œç¡®ä¿çº¿ç¨‹å†…çš„å¼‚æ­¥é“¾å¯è¿½è¸ªã€‚
  - ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šWorker çº¿ç¨‹å†…åˆ›å»ºçš„ `AsyncResource` éœ€åœ¨æ“ä½œå®Œæˆåè°ƒç”¨ `emitDestroy()` æ‰‹åŠ¨é‡Šæ”¾ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼›ä¸»çº¿ç¨‹ä¸­ä¸ Worker ç›¸å…³çš„ `AsyncResource` éœ€åœ¨ Worker é€€å‡ºæ—¶åŒæ­¥é”€æ¯ã€‚

- **æ³¨æ„äº‹é¡¹**
  - é¿å…è·¨çº¿ç¨‹å…±äº« `AsyncLocalStorage` å®ä¾‹ï¼šWorker çº¿ç¨‹æ— æ³•è®¿é—®ä¸»çº¿ç¨‹çš„ `AsyncLocalStorage` å­˜å‚¨ï¼Œéœ€åœ¨ Worker å†…é‡æ–°åˆå§‹åŒ–å¹¶åŸºäºä¼ é€’çš„ä¸Šä¸‹æ–‡æ•°æ®é‡å»ºå­˜å‚¨ã€‚
  - æ§åˆ¶ `AsyncResource` å®ä¾‹åˆ›å»ºé¢‘ç‡ï¼šé«˜é¢‘ Worker é€šä¿¡åœºæ™¯ä¸­ï¼Œé¢‘ç¹åˆ›å»º `AsyncResource` ä¼šå¢åŠ æ€§èƒ½å¼€é”€ï¼Œå¯å¤ç”¨å®ä¾‹æˆ–æ‰¹é‡å¤„ç†å…³è”æ“ä½œã€‚
  - å¤„ç†çº¿ç¨‹é€šä¿¡å»¶è¿Ÿï¼šWorker ä¸ä¸»çº¿ç¨‹çš„æ¶ˆæ¯ä¼ é€’æ˜¯å¼‚æ­¥çš„ï¼Œéœ€ç¡®ä¿ `AsyncResource` åŒ…è£…çš„å›è°ƒèƒ½æ­£ç¡®å…³è”æ¶ˆæ¯å‘é€æ—¶çš„ä¸Šä¸‹æ–‡ï¼ˆè€Œéæ¥æ”¶æ—¶çš„ä¸Šä¸‹æ–‡ï¼‰ã€‚
  - èµ„æºç±»å‹å‘½åè§„èŒƒï¼šè‡ªå®šä¹‰ `AsyncResource` çš„ `type` å‚æ•°å»ºè®®åŒ…å«çº¿ç¨‹æ ‡è¯†ï¼ˆå¦‚ `WORKER_MAIN`ã€`WORKER_THREAD_1`ï¼‰ï¼Œä¾¿äºåœ¨å¤šçº¿ç¨‹æ—¥å¿—ä¸­åŒºåˆ†èµ„æºå½’å±ã€‚
  - å¼‚å¸¸å¤„ç†è¾¹ç•Œï¼šWorker å†…çš„å¼‚æ­¥æ“ä½œå¼‚å¸¸ä¸ä¼šç›´æ¥è§¦å‘ä¸»çº¿ç¨‹çš„ `async_hooks` é”™è¯¯é’©å­ï¼Œéœ€åœ¨ Worker å†…æ•è·å¼‚å¸¸å¹¶é€šè¿‡æ¶ˆæ¯ä¼ é€’ç»™ä¸»çº¿ç¨‹ï¼Œå†ç»“åˆä¸»çº¿ç¨‹çš„ `AsyncResource` æ ‡è®°é”™è¯¯ä¸Šä¸‹æ–‡ã€‚

:::

:::info

```javascript
const { AsyncResource } = require('node:async_hooks');
const { EventEmitter } = require('node:events');
const path = require('node:path');
const { Worker } = require('node:worker_threads');

const kTaskInfo = Symbol('kTaskInfo');
const kWorkerFreedEvent = Symbol('kWorkerFreedEvent');

class WorkerPoolTaskInfo extends AsyncResource {
  constructor(callback) {
    super('WorkerPoolTaskInfo');
    this.callback = callback;
  }

  done(err, result) {
    this.runInAsyncScope(this.callback, null, err, result);
    this.emitDestroy();  // `TaskInfo`s are used only once.
  }
}

class WorkerPool extends EventEmitter {
  constructor(numThreads) {
    super();
    this.numThreads = numThreads;
    this.workers = [];
    this.freeWorkers = [];
    this.tasks = [];

    for (let i = 0; i < numThreads; i++)
      this.addNewWorker();

    // Any time the kWorkerFreedEvent is emitted, dispatch
    // the next task pending in the queue, if any.
    this.on(kWorkerFreedEvent, () => {
      if (this.tasks.length > 0) {
        const { task, callback } = this.tasks.shift();
        this.runTask(task, callback);
      }
    });
  }

  addNewWorker() {
    const worker = new Worker(path.resolve(__dirname, 'task_processor.js'));
    worker.on('message', (result) => {
      // In case of success: Call the callback that was passed to `runTask`,
      // remove the `TaskInfo` associated with the Worker, and mark it as free
      // again.
      worker[kTaskInfo].done(null, result);
      worker[kTaskInfo] = null;
      this.freeWorkers.push(worker);
      this.emit(kWorkerFreedEvent);
    });
    worker.on('error', (err) => {
      // In case of an uncaught exception: Call the callback that was passed to
      // `runTask` with the error.
      if (worker[kTaskInfo])
        worker[kTaskInfo].done(err, null);
      else
        this.emit('error', err);
      // Remove the worker from the list and start a new Worker to replace the
      // current one.
      this.workers.splice(this.workers.indexOf(worker), 1);
      this.addNewWorker();
    });
    this.workers.push(worker);
    this.freeWorkers.push(worker);
    this.emit(kWorkerFreedEvent);
  }

  runTask(task, callback) {
    if (this.freeWorkers.length === 0) {
      // No free threads, wait until a worker thread becomes free.
      this.tasks.push({ task, callback });
      return;
    }

    const worker = this.freeWorkers.pop();
    worker[kTaskInfo] = new WorkerPoolTaskInfo(callback);
    worker.postMessage(task);
  }

  close() {
    for (const worker of this.workers) worker.terminate();
  }
}

module.exports = WorkerPool;
```

:::

## In A Words:

:::note

* Node.js ä¸­ `async_hooks` æ¨¡å—åŠå…¶æ ¸å¿ƒç»„ä»¶ `AsyncLocalStorage`ã€`AsyncResource`ï¼Œæ˜¯å®ç°å¼‚æ­¥æ“ä½œé“¾è·¯è¿½è¸ªä¸ä¸Šä¸‹æ–‡ç®¡ç†çš„å…³é”®å·¥å…·ã€‚å®ƒä»¬å¸¸ä¸ `worker_threads`ï¼ˆå¤šçº¿ç¨‹ä»»åŠ¡å¤„ç†ï¼‰ã€`EventEmitter`ï¼ˆäº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼‰ååŒï¼Œä¸ºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„å¼‚æ­¥è¡Œä¸ºæä¾›ç²¾ç»†åŒ–ç®¡æ§èƒ½åŠ›ï¼ŒåŒ…æ‹¬æµç¨‹è¿½è¸ªã€èµ„æºæ²»ç†ã€å¼‚å¸¸ç›‘æ§ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œæ˜¯æ„å»ºç”Ÿäº§çº§å¼‚æ­¥åº”ç”¨çš„é‡è¦æŠ€æœ¯æ”¯æ’‘ã€‚

### åˆ©ç”¨async_hooksåº“çš„å·¥å…·æ€»ç»“
- **æ€§èƒ½åˆ†æå·¥å…·**ï¼šå€ŸåŠ© `async_hooks` èƒ½å¤Ÿè¿½è¸ªå¼‚æ­¥æ“ä½œçš„ç”Ÿå‘½å‘¨æœŸï¼Œåƒ `async-stack-traces` è¿™ç±»å·¥å…·ï¼Œå¯ä»¥å‡†ç¡®è·å–å¼‚æ­¥æ“ä½œçš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆï¼Œæ¯”å¦‚åœ¨å¤æ‚çš„å¼‚æ­¥ I/O æ“ä½œã€æ•°æ®åº“æŸ¥è¯¢ç­‰åœºæ™¯ä¸­ï¼Œæ˜ç¡®æ˜¯å“ªä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡å¯¼è‡´äº†æ€§èƒ½é—®é¢˜ã€‚
 - **è°ƒè¯•è¾…åŠ©å·¥å…·**ï¼š`async-hook-debug` ç­‰å·¥å…·åˆ©ç”¨ `async_hooks` å¯¹å¼‚æ­¥æ“ä½œçš„è¿½è¸ªï¼Œèƒ½æ›´æ¸…æ™°åœ°å±•ç¤ºå¼‚æ­¥ä»£ç çš„æ‰§è¡Œæµç¨‹ï¼Œåœ¨æ’æŸ¥ä¸å¼‚æ­¥æ“ä½œç›¸å…³çš„é”™è¯¯ï¼Œå¦‚å¼‚æ­¥ä»»åŠ¡é¡ºåºé”™ä¹±ã€å›è°ƒæœªæ­£ç¡®è§¦å‘ç­‰é—®é¢˜æ—¶ï¼Œæä¾›äº†ç›´è§‚çš„ä¿¡æ¯ï¼ŒåŠ å¿«è°ƒè¯•æ•ˆç‡ã€‚
 - **èµ„æºç®¡ç†å·¥å…·**ï¼šä¸€äº›ç”¨äºç®¡ç†èµ„æºçš„å·¥å…·ï¼Œé€šè¿‡ `async_hooks` ç›‘å¬å¼‚æ­¥æ“ä½œçš„åˆ›å»ºå’Œé”€æ¯ï¼Œå®ç°å¯¹èµ„æºçš„ç²¾ç»†åŒ–ç®¡ç†ã€‚ä¾‹å¦‚ï¼Œåœ¨å¤„ç†å¤§é‡å¼‚æ­¥è¿æ¥æ—¶ï¼Œå¯åŠæ—¶å›æ”¶ä¸å†ä½¿ç”¨çš„è¿æ¥èµ„æºï¼Œé¿å…èµ„æºæ³„æ¼ã€‚

### å°†async_hooksé›†æˆåˆ°EFKä¸­çš„æ ¸å¿ƒæ€è·¯
#### æ‰©å±•ç”Ÿæ€æ–¹é¢
- **æ•°æ®é‡‡é›†**ï¼šåœ¨ Elasticsearchï¼ˆESï¼‰çš„æ‘„å…¥é˜¶æ®µï¼Œé€šè¿‡é›†æˆ `async_hooks` ï¼Œå¯¹åº”ç”¨ç¨‹åºäº§ç”Ÿçš„å¼‚æ­¥æ—¥å¿—æ•°æ®è¿›è¡Œæ›´å…¨é¢ã€ç²¾å‡†çš„é‡‡é›†ã€‚æ¯”å¦‚ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼‚æ­¥æ“ä½œå¯èƒ½è·¨è¶Šå¤šä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œåˆ©ç”¨ `async_hooks` è¿½è¸ªè¿™äº›å¼‚æ­¥æ“ä½œï¼Œèƒ½ç¡®ä¿å°†ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯å®Œæ•´æ”¶é›†åˆ° ES ä¸­ï¼Œä¸°å¯Œç”Ÿæ€ä¸­çš„æ•°æ®æ¥æºã€‚
 - **å¯è§†åŒ–å¢å¼º**ï¼šåœ¨ Kibana å¯è§†åŒ–å±‚é¢ï¼ŒåŸºäº `async_hooks` æ”¶é›†åˆ°çš„å¼‚æ­¥æ“ä½œé“¾è·¯æ•°æ®ï¼Œå¼€å‘æ–°çš„å¯è§†åŒ–æ’ä»¶ã€‚ä¾‹å¦‚ï¼Œä»¥å›¾å½¢åŒ–çš„æ–¹å¼å±•ç¤ºå¼‚æ­¥æ“ä½œçš„è°ƒç”¨å…³ç³»å’Œæ‰§è¡Œæ—¶é—´åˆ†å¸ƒï¼Œä½¿è¿ç»´äººå‘˜å’Œå¼€å‘è€…èƒ½æ›´ç›´è§‚åœ°ç†è§£ç³»ç»Ÿä¸­å¼‚æ­¥è¡Œä¸ºçš„å…¨è²Œï¼Œæ‹“å±•ç”Ÿæ€çš„å¯è§†åŒ–èƒ½åŠ›ã€‚
 - **ç”Ÿæ€å¯¹æ¥**ï¼šå°† `async_hooks` ç›¸å…³åŠŸèƒ½ä¸ EFK ç”Ÿæ€ä¸­çš„å…¶ä»–å·¥å…·è¿›è¡Œå¯¹æ¥ï¼Œæ¯”å¦‚ä¸ APMï¼ˆåº”ç”¨æ€§èƒ½ç®¡ç†ï¼‰å·¥å…·é›†æˆã€‚é€šè¿‡ `async_hooks` æä¾›çš„å¼‚æ­¥æ“ä½œæ•°æ®ï¼Œç»“åˆ APM çš„æ€§èƒ½æŒ‡æ ‡åˆ†æï¼Œå®ç°å¯¹åº”ç”¨ç¨‹åºæ€§èƒ½æ›´æ·±å…¥çš„æ´å¯Ÿï¼Œæ‰©å¤§ç”Ÿæ€çš„åŠŸèƒ½è¾¹ç•Œã€‚
 
#### æ ¸å¿ƒæ€è·¯æ•´ç†
 - **å¼‚æ­¥æ—¥å¿—å¢å¼º**ï¼šåˆ©ç”¨ `async_hooks` å¯¹åº”ç”¨ç¨‹åºçš„å¼‚æ­¥æ“ä½œè¿›è¡Œæ ‡è®°å’Œè¿½è¸ªï¼Œåœ¨æ—¥å¿—è®°å½•æ—¶ï¼Œä¸ºæ¯æ¡æ—¥å¿—å…³è”å…¶æ‰€å±çš„å¼‚æ­¥æ“ä½œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚è¿™æ ·ï¼Œåœ¨ Fluentdï¼ˆæˆ–å…¶ä»–æ—¥å¿—æ”¶é›†å·¥å…·ï¼‰è¿›è¡Œæ—¥å¿—ä¼ è¾“ï¼Œä»¥åŠ ES å­˜å‚¨å’Œæ£€ç´¢æ—¶ï¼Œèƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°æŒ‰ç…§å¼‚æ­¥æ“ä½œç»´åº¦è¿›è¡ŒæŸ¥è¯¢å’Œåˆ†æï¼Œæå‡ EFK å¤„ç†å¼‚æ­¥æ—¥å¿—çš„èƒ½åŠ›ã€‚
 - **æ€§èƒ½ç›‘æ§ä¸å‘Šè­¦**ï¼šé€šè¿‡ `async_hooks` æŒç»­ç›‘æ§å¼‚æ­¥æ“ä½œçš„æ‰§è¡Œæ—¶é—´ã€é¢‘ç‡ç­‰æŒ‡æ ‡ï¼Œå½“å‘ç°å¼‚å¸¸æ—¶ï¼Œå°†ç›¸å…³å‘Šè­¦ä¿¡æ¯å‘é€åˆ° EFK ç³»ç»Ÿä¸­ã€‚åœ¨ Kibana ä¸­å±•ç¤ºè¿™äº›å‘Šè­¦ä¿¡æ¯ï¼Œå¹¶ç»“åˆæ—¥å¿—æ•°æ®è¿›è¡Œåˆ†æï¼Œå¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå®šä½å’Œè§£å†³æ€§èƒ½é—®é¢˜ï¼Œå®Œå–„ EFK çš„ç›‘æ§ä½“ç³»ã€‚ 
 - **æ•…éšœæ’æŸ¥ä¼˜åŒ–**ï¼šå½“ç³»ç»Ÿå‡ºç°æ•…éšœæ—¶ï¼Œä¾æ® `async_hooks` æä¾›çš„å¼‚æ­¥æ“ä½œé“¾è·¯ä¿¡æ¯ï¼Œåœ¨ EFK ä¸­å¿«é€Ÿå…³è”å’Œæ£€ç´¢ç›¸å…³çš„æ—¥å¿—è®°å½•ã€‚é€šè¿‡åˆ†æå¼‚æ­¥æ“ä½œçš„å…ˆåé¡ºåºå’Œæ‰§è¡ŒçŠ¶æ€ï¼Œæ›´é«˜æ•ˆåœ°æ‰¾å‡ºæ•…éšœæ ¹æºï¼Œæé«˜ EFK åœ¨æ•…éšœæ’æŸ¥åœºæ™¯ä¸‹çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚ 

:::

:::info

* async_hooks enter ETK_STACK
```
+---------------------+        +-------------------+
| åº”ç”¨ç¨‹åºå¼‚æ­¥æ“ä½œ       | ----> |  async_hooks æ•è·   |
+---------------------+        +-------------------+
          |                            |
          | äº§ç”Ÿå¼‚æ­¥äº‹ä»¶                 | æå–ä¸Šä¸‹æ–‡ä¸é“¾è·¯ä¿¡æ¯
          v                            v
+---------------------+        +-------------------+
| æ—¥å¿—å¢å¼ºå¤„ç†          | <----- |  async_hooks æ•è·  |
+---------------------+        +-------------------+
          |
          | æ·»åŠ å¼‚æ­¥å…ƒæ•°æ®
          v
+---------------------+        +-------------------+
| Fluentd æ—¥å¿—æ”¶é›†     | -----> |      ä¼ è¾“æ—¥å¿—       |
+---------------------+        +-------------------+
          |                            |
          v                            v
+---------------------+        +-------------------+
| Elasticsearch å­˜å‚¨   | <----- |    æ•°æ®ç´¢å¼•ä¸å­˜å‚¨   |
+---------------------+        +-------------------+
          |
          v
+---------------------+
| Kibana å¯è§†åŒ–åˆ†æ     |
+---------------------+
          |
          v
+---------------------+
| å±•ç¤ºå¼‚æ­¥é“¾è·¯ã€ç›‘æ§å‘Šè­¦  |
+---------------------+
          |
          v
+---------------------+
|    è¿ç»´/å¼€å‘äººå‘˜åˆ†æ   |
+---------------------+

# æ€§èƒ½æŒ‡æ ‡åˆ†æ”¯
+-------------------+        +-------------------+
| async_hooks æ•è·   | -----> |     æ€§èƒ½æŒ‡æ ‡é‡‡é›†    |
+-------------------+        +-------------------+
          |                            |
          v                            v
+-------------------+        +-------------------+
| APM ç³»ç»Ÿé›†æˆ        | <-----|   æ€§èƒ½æ•°æ®å…³è”åˆ° ES  |
+-------------------+        +-------------------+
```


* async_hooks æ€§èƒ½åˆ†æå·¥å…·
```
+---------------------+        +-------------------+
| åº”ç”¨å¤šå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ     | -----> | async_hooks ç›‘å¬   |
+---------------------+        +-------------------+
          |                            |
          | å¼‚æ­¥æ“ä½œåˆ›å»º/é”€æ¯             | æ•è·ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
          v                            v
+---------------------+        +-------------------+
|AsyncResource æ ‡è®°èµ„æº | <-----|  async_hooks ç›‘å¬  |
+---------------------+        +-------------------+
          |
          | è®°å½•æ“ä½œè€—æ—¶ã€è°ƒç”¨æ ˆ
          v
+---------------------+        +-------------------+
|   æ€§èƒ½æ•°æ®èšåˆ        | -----> | async-stack-traces|
+---------------------+        +-------------------+
          |                            |
          | ç”Ÿæˆæ€§èƒ½æŒ‡æ ‡                 | å±•ç¤ºå¼‚æ­¥è°ƒç”¨é“¾ã€æ€§èƒ½ç“¶é¢ˆ
          v                            v
+---------------------+        +-------------------+
| å¼€å‘è€…åˆ†æä¼˜åŒ–        | <----- | async-stack-traces|
+---------------------+        +-------------------+

# å¼‚å¸¸è¿½è¸ªåˆ†æ”¯
+-------------------+        +-------------------+
| async_hooks ç›‘å¬   | -----> | å¼‚å¸¸å¼‚æ­¥æ“ä½œè¯†åˆ«     |
+-------------------+        +-------------------+
          |                            |
          v                            v
+-------------------+        +-------------------+
| é”™è¯¯è¿½è¸ªå·¥å…·é›†æˆ     | <----- |   å…³è”å¼‚æ­¥ä¸Šä¸‹æ–‡    |
+-------------------+        +-------------------+
          |
          v
+-------------------+
| é”™è¯¯æ—¥å¿—ç³»ç»Ÿ        |
+-------------------+
```

* async_hooks åœ¨æ€§èƒ½åˆ†æå·¥å…·ä¸­
```
+---------------------+        +----------------------+
| åˆ†å¸ƒå¼æœåŠ¡è°ƒç”¨        | -----> | async_hooks æ³¨å…¥ä¸Šä¸‹æ–‡ |
+---------------------+        +----------------------+
          |                            |
          | è·¨æœåŠ¡å¼‚æ­¥è¯·æ±‚               | æºå¸¦ traceId/spanId
          v                            v
+---------------------+        +-------------------+
| RPC æ¡†æ¶ä¼ è¾“         | -----> | è·¨æœåŠ¡ä¼ é€’ä¸Šä¸‹æ–‡     |
+---------------------+        +-------------------+
          |                            |
          v                            v
+---------------------+        +----------------------+
| å„æœåŠ¡å¼‚æ­¥æ“ä½œ        | <----- | async_hooks æ•è·ä¸Šä¸‹æ–‡ |
+---------------------+        +----------------------+
          |
          | æœåŠ¡å†…æ—¥å¿—/æŒ‡æ ‡æ”¶é›†
          v
+---------------------+        +--------------------------+
| ä¸ŠæŠ¥è¿½è¸ªæ•°æ®          | -----> | åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼ˆå¦‚ Jaegerï¼‰ |
+---------------------+        +--------------------------+
          |                            |
          | æ•´åˆè·¨æœåŠ¡å¼‚æ­¥é“¾è·¯            | å…¨å±€è°ƒç”¨é“¾å¯è§†åŒ–
          v                            v
+---------------------+        +--------------------------+
| å±•ç¤ºç«¯åˆ°ç«¯å¼‚æ­¥æµç¨‹     | <----- | åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼ˆå¦‚ Jaegerï¼‰ |
+---------------------+        +--------------------------+
          |
          v
+---------------------+
| è¿ç»´/å¼€å‘æ’æŸ¥åˆ†å¸ƒå¼é—®é¢˜ |
+---------------------+
```

:::
